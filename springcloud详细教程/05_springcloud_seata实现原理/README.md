### Seata框架详解

### 一、Seata是什么？

#### 1.1 前言

Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata降为用户提供了AT，TCC，SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。

#### 1.2 Seata术语

```java
1. TC(Transaction Coordinator) 事务协调者：维护全局和分支事务的状态，驱动全局失误提交或回滚
2. TM (Trancsction Manager) 事务管理器：定义全局事务的范围：开始全局事务，提交或回滚全局事务。
3. RM（Resource Manager）资源管理器：管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。
```

##### 1.2.1 **理解**：

- 首先来看TM，是定义分布式事务范围的作用。类似于本地事务的 begin...commit...rolback 的作用。只不过其定义的是全局分布式事务范围，这就需要知道有几个分布式分支的事务完成后才 commit。
- 然后再看TC，TC是具体的协调和执行者。它监控每个分布式分支事务执行成功与否，然后判断整体分布式事务是提交还是回滚。TM定义范围，TC用于联络各分支与TM的范围，推动总体分布式事务进程。

- RM是各分布式分支的监控器。监控各分支本地事务执行情况，然后通知给TC，同时驱动各分支本地事务的退静，是提交还是回滚。

##### 1.2.2 总体概括

​	TM是一个分布式事务的发起者和终结者，TC负责维护分布式事务的运行状态，而RM则负责本地事务的运行。

##### 1.2.3 分布式事务执行流程

![1](images/1.png)

官网扒下来的图，借助此图解释一下SEATA执行分布式事务的流程，同时体会TC、TM和RM之间的关系和作用。

在上图中，涉及到四个微服务系统，分别是Business系统，Stock系统，Order系统和Account系统。当执行某个业务时，**Bussiness系统** 远程调用了 **Stock系统** 和 **Order系统** ，**Order系统 **又远程调用了**Account系统** ，相当于发生了三次远程调用，才执行完这个业务操作。而且这几个远程调用的方法要求具有原子性，即出现了分布式事务场景。

1. 使用Seata框架，在 Bussiness系统发生的远程调用，所以Business是TM角色，定义分布式事务的范围，并向TC申请开启一个全局事务。TC生成一个全局事务并发生一个全局唯一 XID返回给 TM。
2. TM 获取到 XID 后，携带 XID 进行远程调用，XID 在微服务链路中进行传递。
3. 各分支事务获取到 XID 后，与 TC 进行通信，注册各分支本地事务，并执行本地事务，执行结果(提交/回滚)提交给 TC 。
4. TM 根据 TC 中记录的各分支事务的提交状态，发起全局事务的提交或回滚。

5. TC 调度 XID 下所有分支事务进行提交或回滚操作。

以上就是SEATA 执行分布式事务整体流程。

##### 1.2.4 问题：

理解了上述过程后，会有几个问题在脑海中出现，

```java
1. 由上图可以看到，TM和RM 都与 TC 进行通信，那么 TC 到底是个什么东西？
2. RM 执行各自分支的事务，加入有的分支事务提交了，有的分支事务回滚了，那么在第五步中，TC 是要对所有分支事务进行回滚的，而执行成功的分支事务，如何在回滚回去呢？
```

#### 1.3 Seata 几种不同的事务模式

> Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。

下面分别学习这几种事务模式特性和区别。

##### 1.3.1 AT模式

**前提**：

- 基于支持本地 ACID 事务的关系型数据库。
- Java应用，通过JDBC访问数据库。

**整体机制**：

```java
两阶段提交协议的演变：
  1. 一阶段: 业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和链接资源。
  2. 二阶段: 
			提交异步化，非常快速的完成。
      回滚通过一阶段的回滚日志进行反向补偿。
```

可以看到，AT模式通过回滚日志，来回滚提交成功后的事务。这也解答了上面问题中的第二个问题。具体是如何通过回滚日志回滚的呢？看下面的工作机制。

**工作机制**：

seata为我们提供了日志回滚表，不同的数据库回滚表结构有差异，Mysql数据日志回滚表结构如下：









- **AT模式**：无侵入式的分布式事务解决方案，适合不希望对业务进行改造的场景，但由于需要添加全局事务锁，对影响高并发系统的性能。该模式主要关注多DB访问的数据一致性，也包括服务下的多DB数据访问一致性问题。





- **TCC模式**：高性能的分布式解决方案，适用于对想能要求比较高的场景。该模式主要关注业务拆分，在按照业务横向扩展资源时，解决服务间调用的一致性问题。

- **Sage模式**：长事务的分布式事务解决方案，适用于业务流程长且需要保证事务最终一致性的业务系统。Sage模式一阶段就会提交本地事务，无锁，长流程情况下可以保证性能，多用于渠道层，集成层业务系统，事务参与者可以是其它公司的服务也可以是遗留系统的服务，并且对于无法进行改造和提供 TCC 要求的接口，也可以使用 Sage 模式

#### 1.4 Seata的整体执行流程
